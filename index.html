<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
</head>
<body class="h-100vh d-flex align-items-center justify-content-center">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <form class="d-none form-submit" method="post" action="https://stage.ustd.town/vapid">
        <input type="hidden" name="json" class="input-vapid">
        <button type="submit">Subscribe and go</button>
    </form>
    
    <script>
        const publicVapidKey = 'BJ5lPY0qjF1Tx9v9AvS7ajodgmXdmOCiPwpROPmBMY2Jk3DRaxCe6q8NoW8vS592V0-kec77xMPO514qf5AcVk4';
        const dom = {
            loading: document.querySelector('.spinner-border'),
            form: document.querySelector('.form-submit'),
            input: document.querySelector('.input-vapid'),
        }
        const options = {
            userVisibleOnly: true,
            applicationServerKey: urlB64ToUint8Array(publicVapidKey)
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                    console.log('Service Worker successful registration:', reg);
                    dom.loading.classList.add('d-none')
                    dom.form.classList.remove('d-none')
                    dom.form.onsubmit = e => {
                        e.preventDefault()
                        reg.pushManager.subscribe(options)
                            .then(subscription => {
                                console.log('User Subscription:', subscription);
                                dom.input.value = JSON.stringify(subscription);
                                dom.form.submit();
                            })
                            .catch(err => {
                                console.error('Subscription failed:', err);
                                dom.form.submit();
                            });
                    }
                    
                })
                .catch(err => console.error('Service Worker registration failed:', err));
        }

        function urlB64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
        }
    </script>
</body>
</html>
